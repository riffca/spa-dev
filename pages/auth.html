<div class="flex bg-black  items-start justify-center bg-grey-200">
	<div class="p-12 text-white gap-4 flex flex-col">
		<app-title>
			<div>Authorization</div> 
		</app-title>

		<div class="text-black flex flex-col gap-4">
			<app-input data-class="classes.email" data-model="credentials.email">
				<div class="py-2" data-show="errors.email">{errors.email}</div>
			</app-input>
			<app-input data-class="classes.password" data-model="credentials.password">
				<div class="py-2" data-show="errors.password">{errors.password}</div>
			</app-input>	
		</div>
		<div data-show="shownServerErrors" class="text-red-500">{serverMessages}</div>
		<app-button-action data-click="onRegisterClick"><span>Register</span></app-button-action>
		<app-button-action data-click="onLoginClick"><span>Login</span></app-button-action>
	</div>
<div>

<script type="module">

import { register, login } from './js/firestore/lib.js';
import { registerUser } from './js/store/auth.js';

$spa.initCustomElement({
	name: 'page-auth',
	attrs: [
		'credentials', 
		'errors', 
		'classes', 
		'server-messages'
	],
});

const { element, proxy } = $spa.getRoots($componentId)

proxy.credentials = {
	email: '',
	password: '',
}

proxy.errors = {}
proxy.classes = {}
proxy.serverMessages = []


$spa.watch('credentials', (value)=> {
	//validate(value)
})

proxy.shownServerErrors = ()=>Boolean(proxy.serverMessages?.length)

function validate(value){
	const errors = {}
	const classes = {}
	const { password, email } = proxy.credentials

	if(password?.length < 5) {
		errors.password = 'min length 5'
		classes.password = 'text-red-300'

	}
	if(email?.length < 5) {
		errors.email = 'min length 5'
		classes.email = 'text-red-300'

	}
	proxy.errors = errors
	proxy.classes = classes
}

function setServerErrors(errors){
	if(errors?.length) {
		proxy.serverMessages = errors.map(item=> item.message).join('/n')
	}
}

function validateCheck(){
	validate(proxy.credentials)
	if(Object.keys(proxy.errors).length) return true
}


async function onLoginClick(){
	if(validateCheck()) return

	const { errors } = await login({
		email: proxy.credentials.email,
		password: proxy.credentials.password,
	})
	setServerErrors(errors)
}

async function onRegisterClick(){
	if(validateCheck()) return

	const { errors } = await registerUser({
		email: proxy.credentials.email,
		password: proxy.credentials.password,
	})

	errors && setServerErrors(errors)
}

</script>